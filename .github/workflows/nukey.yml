name: AWS Nuke (Sandbox)

on:
  workflow_dispatch:

jobs:
  aws-nuke:
    runs-on: ubuntu-latest
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

    steps:
    - name: Install aws-nuke (ekristen fork)
      run: |
        wget https://github.com/ekristen/aws-nuke/releases/latest/download/aws-nuke-linux-amd64 -O aws-nuke
        chmod +x aws-nuke
        sudo mv aws-nuke /usr/local/bin/
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    - name: Generate nuke config
      run: |
        cat > nuke-config.yaml <<EOF
        regions:
          - global
          - us-east-1
          - us-west-2
        account-blocklist:
          - "000000000000"
        accounts:
          "${AWS_ACCOUNT_ID}": {}
        EOF
    - name: Dry Run (Preview Plan)
      run: |
        echo "=== Dry-run output ==="
        aws-nuke run -c nuke-config.yaml --no-dry-run=false | tee dry-run.txt
    - name: Upload dry-run log for review
      uses: actions/upload-artifact@v3
      with:
        name: dry-run-log
        path: dry-run.txt
    - name: ðŸš« Stop before deletion
      run: echo "Review the dry-run log artifact. Re-run with deletion enabled."

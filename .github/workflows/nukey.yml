name: AWS Nuke Resources

on:
  workflow_dispatch:

jobs:
  nuke:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: eu-north-1
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Debug AWS Identity
        run: |
          echo "üîê Verifying identity..."
          aws sts get-caller-identity
          aws configure list
          env | grep AWS

      - name: Install aws-nuke
        run: |
          wget https://github.com/rebuy-de/aws-nuke/releases/download/v3.56.2/aws-nuke-v3.56.2-linux-amd64.tar.gz
          tar -xvf aws-nuke-v3.56.2-linux-amd64.tar.gz
          sudo mv aws-nuke-v3.56.2-linux-amd64 /usr/local/bin/aws-nuke

      - name: Ensure Account Alias Exists
        run: |
          echo "üîß Checking for account alias..."
          ALIAS=$(aws iam list-account-aliases --query 'AccountAliases[0]' --output text)
          if [ "$ALIAS" = "None" ] || [ -z "$ALIAS" ]; then
            echo "‚ö†Ô∏è No alias found. Creating 'sandbox-nuke'"
            aws iam create-account-alias --account-alias "sandbox-nuke" || true
          else
            echo "‚úÖ Alias exists: $ALIAS"
          fi

      - name: Create aws-nuke config
        run: |
          cat <<EOF > nuke-config.yaml
          regions:
            - $AWS_REGION

          account-blocklist: []

          accounts:
            $AWS_ACCOUNT_ID:
              filters:
                IAMUser:
                  - "github-actions"

          EOF

      - name: Run AWS Nuke
        run: |
          echo "üí£ Nuking resources in account $AWS_ACCOUNT_ID"
          aws-nuke -c nuke-config.yaml --no-dry-run --force

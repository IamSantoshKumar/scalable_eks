name: AWS Nuke

on:
  workflow_dispatch:  # Manually trigger from GitHub UI

jobs:
  nuke:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install aws-nuke
        run: |
          wget https://github.com/rebuy-de/aws-nuke/releases/download/v3.56.2/aws-nuke-v3.56.2-linux-amd64.tar.gz
          tar -xzf aws-nuke-v3.56.2-linux-amd64.tar.gz
          sudo mv aws-nuke-v3.56.2-linux-amd64/aws-nuke /usr/local/bin/aws-nuke

      - name: Manually configure AWS credentials
        run: |
          mkdir -p ~/.aws
          echo "[default]" > ~/.aws/credentials
          echo "aws_access_key_id=${{ secrets.AWS_ACCESS_KEY_ID }}" >> ~/.aws/credentials
          echo "aws_secret_access_key=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> ~/.aws/credentials
          echo "[default]" > ~/.aws/config
          echo "region=eu-north-1" >> ~/.aws/config

      - name: Ensure AWS account alias exists
        run: |
          ALIAS_NAME="sandbox-nuke-${{ github.run_id }}"
          CURRENT_ALIAS=$(aws iam list-account-aliases --query 'AccountAliases[0]' --output text || true)

          if [ "$CURRENT_ALIAS" = "None" ] || [ -z "$CURRENT_ALIAS" ]; then
            echo "No alias found. Creating alias: $ALIAS_NAME"
            aws iam create-account-alias --account-alias "$ALIAS_NAME" || true
          else
            echo "Alias already exists: $CURRENT_ALIAS"
          fi

      - name: Create nuke config file
        run: |
          cat <<EOF > nuke-config.yaml
          regions:
            - eu-north-1
          account-blocklist: []
          resource-types:
            targets:
              - '*'
          accounts:
            ${{ secrets.AWS_ACCOUNT_ID }}:
              filters:
                IAMUser:
                  - "github-actions"  # prevent nuking runner identity
          EOF

      - name: Run aws-nuke
        run: |
          echo "Running aws-nuke in account: ${{ secrets.AWS_ACCOUNT_ID }}"
          aws-nuke -c nuke-config.yaml --no-dry-run --force

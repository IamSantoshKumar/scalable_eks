name: AWS Nuke (Full Cleanup)

on:
  workflow_dispatch:

jobs:
  aws-nuke:
    runs-on: ubuntu-latest
    env:
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      AWS_ALIAS: sandbox-nuke-${{ secrets.AWS_ACCOUNT_ID }}

    steps:
    - name: Install aws-nuke
      run: |
        wget https://github.com/ekristen/aws-nuke/releases/download/v3.56.2/aws-nuke-v3.56.2-linux-amd64.tar.gz -O aws-nuke.tar.gz
        tar -xzf aws-nuke.tar.gz
        chmod +x aws-nuke
        sudo mv aws-nuke /usr/local/bin/

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-north-1

    - name: Ensure unique account alias exists
      run: |
        set -e
        ALIAS=$(aws iam list-account-aliases --query 'AccountAliases[0]' --output text)
        if [ "$ALIAS" = "None" ] || [ -z "$ALIAS" ]; then
          echo "Creating account alias: $AWS_ALIAS"
          aws iam create-account-alias --account-alias "$AWS_ALIAS"
        else
          echo "Alias already exists: $ALIAS"
        fi

    - name: Generate nuke config file
      run: |
        echo "regions:" > nuke-config.yaml
        echo "  - global" >> nuke-config.yaml
        echo "  - eu-north-1" >> nuke-config.yaml
        echo "blocklist:" >> nuke-config.yaml
        echo "  - \"000000000000\"" >> nuke-config.yaml
        echo "accounts:" >> nuke-config.yaml
        echo "  \"${AWS_ACCOUNT_ID}\":" >> nuke-config.yaml
        echo "    filters: {}" >> nuke-config.yaml

    - name: Nuking all resources in account
      run: |
        echo "Running aws-nuke on account: $AWS_ACCOUNT_ID"
        aws-nuke run -c nuke-config.yaml --no-dry-run --force
